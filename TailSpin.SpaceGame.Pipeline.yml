steps:
  # Download artifacts for web app, db, and Bicep/ARM
  - download: current
    displayName: App Download
    artifact: dropApp
  - download: current
    displayName: ARM Template Download
    artifact: dropARM
  - download: current
    displayName: Dacpac Download
    artifact: dropDacpac

  - task: replacetokens@3
    displayName: 'Replace Tokens with Variables'
    inputs:
      targetFiles: '$(Pipeline.Workspace)/dropARM/$(infrAsCodeFolder)/*.json'
      encoding: 'auto'
      writeBOM: true
      escapeType: 'none'
      actionOnMissing: 'fail'
      keepToken: false
      tokenPrefix: '__'
      tokenSuffix: '__'
      useLegacyPattern: false
      enableTelemetry: true

  - task: AzureCLI@2
    # Only run in Dev. What-if is not production ready because of issues like https://github.com/Azure/arm-template-whatif/issues/73
    displayName: 'Preview ARM template changes'
    condition: eq(variables['System.StageName'], 'dev')
    inputs:
      azureSubscription: '$(serviceConnection)'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az deployment sub what-if --location WestUS --template-file $(Pipeline.Workspace)/dropARM/$(infrAsCodeFolder)/main.json
    
  - task: AzureCLI@2
    displayName: 'Deploy ARM Template'
    inputs:
      azureSubscription: '$(serviceConnection)'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az deployment sub create --location WestUS --template-file $(Pipeline.Workspace)/dropARM/$(infrAsCodeFolder)/main.json
    condition: succeeded() 

  - task: SqlAzureDacpacDeployment@1
    displayName: Generate DB schema change script
    inputs:
      azureSubscription: '$(serviceConnection)'
      authenticationType: 'server'
      serverName: '$(sqlServerName).database.windows.net'
      databaseName: '$(dbname)'
      sqlUsername: '$(adminlogin)'
      sqlPassword: '$(adminPassword)'
      deployType: 'DacpacTask'
      deploymentAction: 'Script'
      dacpacFile: '$(Pipeline.Workspace)/dropDacpac/$(dbSchemaFolder)/bin/Debug/$(dbSchemaFolder).dacpac'
      ipDetectionMethod: 'AutoDetect'

  - task: PowerShell@2
    displayName: Show DB change script and check for schema changes
    inputs:
      targetType: 'inline'
      script: | 
        # Print the schema change script
        Write-Host "Auto Generated SQL Update Script:"
        Get-Content $(Build.SourcesDirectory)\GeneratedOutputFiles\$(dbname)_Script.sql | foreach {Write-Output $_}

        # Check for schema changes
        $file = Get-Content "$(Build.SourcesDirectory)\GeneratedOutputFiles\$(dbname)_Script.sql"
        $containsWord = $file | %{$_ -match "CREATE" -or $_ -match "ALTER" -or $_ -match "DROP"}
        if ($containsWord -contains $true) {
          Install-Module VSTeam -Scope CurrentUser -Force
          Set-VSTeamAccount â€“Account $(System.CollectionUri) -PersonalAccessToken $(PAT)
          $methodParameters = @{
            ProjectName = "$(System.TeamProject)"
            Name = "SpaceGame"}
          $vg = Get-VSTeamVariableGroup @methodParameters
          $vars = @{}
          $vg.variables | Get-Member -MemberType *Property | %{$vars.($_.Name) = $vg.variables.($_.Name)}
          $varName = "schemaChanged"
          $vars.$varName= @{}
          $vars.$varName.value = "True"
          $vars.$varName.isSecret = $false
          $methodParameters = @{
            id = $vg.id
            ProjectName = "$(System.TeamProject)"
            Name = "SpaceGame"
            Description = ""
            Type = "Vsts"
            Variables = $vars}
          Update-VSTeamVariableGroup @methodParameters}

  - task: SqlAzureDacpacDeployment@1
    displayName: 'Deploy DB'
    inputs:
      azureSubscription: '$(serviceConnection)'
      authenticationType: 'server'
      serverName: '$(sqlServerName).database.windows.net'
      databaseName: '$(dbName)'
      sqlUsername: '$(adminlogin)'
      sqlPassword: '$(adminPassword)'
      deployType: 'DacpacTask'
      deploymentAction: 'Publish'
      dacpacFile: '$(Pipeline.Workspace)/dropDacpac/$(dbSchemaFolder)/bin/Debug/$(dbSchemaFolder).dacpac'
      ipDetectionMethod: 'AutoDetect'

  - task: AzureWebApp@1
    displayName: 'Deploy app (no slot)'
    condition: eq(variables['System.StageName'], 'dev')
    inputs:
      azureSubscription: '$(serviceConnection)'
      appName: '$(appservicename)'
      package: '$(Pipeline.Workspace)/dropApp/$(buildConfiguration)/*.zip'

  - task: AzureWebApp@1
    displayName: 'Deploy app to deploy slot'
    condition: ne(variables['System.StageName'], 'dev')
    inputs:
      azureSubscription: '$(serviceConnection)'
      deployToSlotOrASE: 'true'
      slotName: 'swap'
      appName: '$(appservicename)'
      package: '$(Pipeline.Workspace)/dropApp/$(buildConfiguration)/*.zip' 

  - task: AzureAppServiceManage@0
    displayName: 'Swap deployment slots'
    condition: ne(variables['System.StageName'], 'dev')    
    inputs:
      azureSubscription: '$(serviceConnection)'
      resourceGroupName: '$(resourceGroup)'
      webAppName: '$(appservicename)'
      sourceSlot: 'swap'
      targetSlot: 'production'
      action: 'Swap Slots'